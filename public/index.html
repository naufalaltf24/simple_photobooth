<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modern Photobooth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .modal {
        display: none;
        position: fixed;
        z-index: 50;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: linear-gradient(135deg, #e0f2fe 0%, #f3f4f6 100%);
        margin: auto;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 500px;
        text-align: center;
        position: relative;
      }
      .modal-header {
        font-size: 24px;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 16px;
      }
      .modal-footer {
        font-size: 14px;
        color: #6b7280;
        margin-top: 16px;
      }
      .close-btn {
        position: absolute;
        top: 10px;
        right: 20px;
        color: #6b7280;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close-btn:hover {
        color: #1f2937;
      }
      #previewCanvas {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 360px;
        margin: 0 auto;
      }
      #countdown {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 48px;
        font-weight: bold;
        color: white;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        z-index: 10;
        display: none;
      }
      #video {
        transform: scaleX(-1); /* Flip video feed horizontally */
      }
    </style>
  </head>
  <body class="bg-[#581C87] flex items-center justify-center min-h-screen">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl">
      <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">
        Photobooth Sekita
      </h1>
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1 relative">
          <video
            id="video"
            class="w-full rounded-lg shadow-md"
            autoplay
          ></video>
          <div id="countdown"></div>
          <canvas id="canvas" class="hidden"></canvas>
        </div>
        <div class="flex-1">
          <div id="photoContainer" class="grid grid-cols-3 gap-4 mb-4">
            <div id="photo1" class="bg-gray-200 h-32 rounded-lg"></div>
            <div id="photo2" class="bg-gray-200 h-32 rounded-lg"></div>
            <div id="photo3" class="bg-gray-200 h-32 rounded-lg"></div>
          </div>
          <div class="flex gap-4 mb-4">
            <button
              id="captureBtn"
              class="bg-[#581C87] text-white px-4 py-2 rounded hover:bg-blue-600"
            >
              Take Photo
            </button>
            <button
              id="retakeBtn"
              class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 hidden"
            >
              Retake
            </button>
          </div>
          <div id="emailSection" class="hidden">
            <input
              id="emailInput"
              type="email"
              placeholder="Enter your email"
              class="w-full p-2 border rounded mb-4"
            />
            <button
              id="sendBtn"
              class="bg-[#581C87] text-white px-4 py-2 rounded hover:bg-green-600"
            >
              Send Photos
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Preview -->
    <div id="previewModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">Ã—</span>
        <div class="modal-header">Your Photobooth Memories</div>
        <canvas id="previewCanvas"></canvas>
        <div class="modal-footer" id="previewFooter"></div>
      </div>
    </div>

    <script>
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const previewCanvas = document.getElementById("previewCanvas");
      const previewModal = document.getElementById("previewModal");
      const captureBtn = document.getElementById("captureBtn");
      const retakeBtn = document.getElementById("retakeBtn");
      const sendBtn = document.getElementById("sendBtn");
      const emailInput = document.getElementById("emailInput");
      const photoContainer = document.getElementById("photoContainer");
      const previewFooter = document.getElementById("previewFooter");
      const countdownDisplay = document.getElementById("countdown");
      let photos = [];
      let photoCount = 0;

      // Access webcam
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => (video.srcObject = stream))
        .catch((err) => alert("Error accessing camera: " + err));

      // Capture photo with countdown
      captureBtn.addEventListener("click", () => {
        if (photoCount < 3) {
          captureBtn.disabled = true;
          let countdown = 3;
          countdownDisplay.style.display = "block";
          countdownDisplay.textContent = countdown;

          const countdownInterval = setInterval(() => {
            countdown--;
            countdownDisplay.textContent = countdown;
            if (countdown === 0) {
              clearInterval(countdownInterval);
              countdownDisplay.style.display = "none";
              capturePhoto();
              captureBtn.disabled = false;
            }
          }, 1000);
        }
      });

      // Function to capture photo
      function capturePhoto() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        // Flip the context horizontally
        ctx.scale(-1, 1);
        ctx.drawImage(
          video,
          -video.videoWidth,
          0,
          video.videoWidth,
          video.videoHeight
        );
        ctx.scale(-1, 1); // Reset the scale
        photos.push(canvas.toDataURL("image/png"));
        document.getElementById(
          `photo${photoCount + 1}`
        ).innerHTML = `<img src="${photos[photoCount]}" class="w-full h-full object-cover rounded-lg">`;
        photoCount++;
        if (photoCount === 3) {
          captureBtn.classList.add("hidden");
          retakeBtn.classList.remove("hidden");
          document.getElementById("emailSection").classList.remove("hidden");
          updatePreview();
        }
      }

      // Retake photos
      retakeBtn.addEventListener("click", () => {
        photos = [];
        photoCount = 0;
        photoContainer
          .querySelectorAll("div")
          .forEach((div) => (div.innerHTML = ""));
        captureBtn.classList.remove("hidden");
        retakeBtn.classList.add("hidden");
        document.getElementById("emailSection").classList.add("hidden");
        previewModal.style.display = "none";
      });

      // Update preview for vertical layout in modal
      function updatePreview() {
        previewModal.style.display = "flex";
        const ctx = previewCanvas.getContext("2d");
        previewCanvas.width = 1080;
        previewCanvas.height = 1920;
        const photoHeight = previewCanvas.height / 3;
        const photoWidth = video.videoWidth * (photoHeight / video.videoHeight);
        const xOffset = (previewCanvas.width - photoWidth) / 2;
        let loadedPhotos = 0;

        photos.forEach((photo, i) => {
          const img = new Image();
          img.src = photo;
          img.onload = () => {
            // Draw photo (already flipped from capture)
            ctx.drawImage(
              img,
              xOffset,
              i * photoHeight,
              photoWidth,
              photoHeight
            );
            loadedPhotos++;
            const frameSrc =
              i < 2 ? "/storage/Frame-1.png" : "/storage/Frame-2.png";
            const frameImg = new Image();
            frameImg.src = frameSrc;
            frameImg.onload = () => {
              ctx.drawImage(
                frameImg,
                xOffset,
                i * photoHeight,
                photoWidth,
                photoHeight
              );
              if (loadedPhotos === photos.length) {
                previewFooter.textContent = `Taken on 3 June 2025`;
              }
            };
          };
        });
      }

      // Close modal
      function closeModal() {
        previewModal.style.display = "none";
      }

      // Send email
      sendBtn.addEventListener("click", () => {
        const email = emailInput.value;
        if (!email) return alert("Please enter a valid email");
        previewCanvas.toBlob((blob) => {
          const formData = new FormData();
          formData.append("email", email);
          formData.append("photo", blob, "photobooth.png");
          fetch("/send-email", {
            method: "POST",
            body: formData,
          })
            .then((res) => res.json())
            .then((data) => alert(data.message))
            .catch((err) => alert("Error sending email: " + err));
        });
      });
    </script>
  </body>
</html>
